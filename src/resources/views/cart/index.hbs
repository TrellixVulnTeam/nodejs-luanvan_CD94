<script src="../js/cart.js"></script>

<div class="container">
    <div class="bg-white">
        <div class="row sticky-top">
            {{>nav-bar}}
        </div>
        <div class="cart-content">
            <center>
                <h1><i class="fas fa-cart-arrow-down"></i> GIỎ HÀNG CỦA BẠN</h1>
            </center>
            <br>
            <br>
            <div class="row">
                <div class="col-12 col-md-12 col-lg-8">
                    <div id="gio-hang">

                    </div>
                </div>
                <div class="col-12 col-md-12 col-lg-4">
                    {{>cart-total}}
                </div>
            </div>
        </div>
    </div>
</div>

<form name="submit-cart-form" method="POST">
     <div id="total-order-money">

     </div>
</form>

<script>
    showListItemCart();
    showTotalMoney();

    function showTotalMoney() {
        var listItemCart = getListItemCart();
        var totalMoney = 0;
        for (var i = 0; i < listItemCart.length; i++) {
            var money = listItemCart[i].price * listItemCart[i].amount;
            totalMoney += money;
        }
        var moneyTotal = document.getElementById('total-money-show');
        moneyTotal.innerText = '';
        moneyTotal.innerHTML = '<span>' + totalMoney + '<small>.000</small></span>';

        var totalOrderMoney = document.getElementById('total-order-money');
        totalOrderMoney.innerHTML =  '<input type="hidden" id="totalmoney" name="totalmoney" value="' + totalMoney + '">'
    }

    function submitCartString() {
        var listItemCart = getListItemCart();
        var HTML = listItemCartToString(listItemCart);

        var submitCartForm = document.forms['submit-cart-form'];

        submitCartForm.action = '/cart/123456' + '?q=' + HTML + '';
        submitCartForm.submit();
        deleteListItemCartInLocal();
    }

    function deleteListItemCartInLocal() {
        var jsonListItemCart = '[]';
        localStorage.setItem(keyLocalStorageItemCart, jsonListItemCart);
    }

    function listItemCartToString(listItemCart) {
        var allString = '';
        for (var i = 0; i < listItemCart.length; i++) {
            allString = allString + itemCartToString(listItemCart[i]);
        }
        return allString;
    }

    function itemCartToString(itemCart) {
        var string = '/' + itemCart.id + '-' + itemCart.amount;
        return string;
    }

    function xoa(id) {
        var nodeCart = document.getElementById(id + 'main');
        nodeCart.parentNode.removeChild(nodeCart);
        deleteItemCartInLocal(id);
        addAmountInnerID('cart-text');
        showTotalMoney();
    }

    // tăng một số lượng của sản phẩm
    function tang(id) {
        var ListItemCart = getListItemCart();
        var sl;
        var price;
        for (var i = 0; i < ListItemCart.length; i++) {
            var itemCart = ListItemCart[i];
            if (itemCart.id == id) {
                itemCart.amount++;
                sl = itemCart.amount;
                price = itemCart.price;
            }
        }
        saveListItemCartInLocal(ListItemCart);

        // lấy ô chứa số lượng
        var nodeCart = document.getElementById(id);

        // Lấy ô chứa tổng tiền
        var totalPrice = document.getElementById(id + 'price');
        price = sl * price;

        // thay đổi giá và số lượng
        totalPrice.innerText = "";
        totalPrice.innerHTML = '<span>' + price + '<small>.000đ</small></span>';
        nodeCart.innerText = "";
        nodeCart.innerText = sl;

        showTotalMoney();
    }

    // giảm một số lượng của sản phẩm
    function giam(id) {
        var ListItemCart = getListItemCart();
        var sl;
        var price;
        for (var i = 0; i < ListItemCart.length; i++) {
            var itemCart = ListItemCart[i];
            if (itemCart.id == id) {
                if (itemCart.amount == 1) {
                    itemCart.amount = 1;
                    sl = itemCart.amount;
                    price = itemCart.price;
                    break;
                }
                itemCart.amount--;
                sl = itemCart.amount;
                price = itemCart.price;
            }
        }
        saveListItemCartInLocal(ListItemCart);

        // lấy ô chứa số lượng
        var nodeCart = document.getElementById(id);

        // Lấy ô chứa tổng tiền
        var totalPrice = document.getElementById(id + 'price');
        price = sl * price;

        // thay đổi giá và số lượng
        totalPrice.innerText = "";
        totalPrice.innerHTML = '<span>' + price + '<small>.000đ</small></span>';
        nodeCart.innerText = "";
        nodeCart.innerText = sl;

        showTotalMoney();
    }

    // hiển thị danh sách sản phẩm lên giỏ hàng
    function showListItemCart() {
        var listItemCart = getListItemCart();
        var HTML = listItemCartToHTML(listItemCart);
        var nodeCart = document.getElementById('gio-hang');
        nodeCart.innerHTML = HTML;
    }

    // chuyển một danh sách thành html
    function listItemCartToHTML(listItemCart) {
        var allHTML = '';
        for (var i = 0; i < listItemCart.length; i++) {
            allHTML = allHTML + itemCartToHTML(listItemCart[i]);
        }
        return allHTML;
    }

    // chuyển một đối tượng thành html
    function itemCartToHTML(itemCart) {
        var price = itemCart.amount * itemCart.price;
        var truoc = '\'';
        var id = truoc + itemCart.id + truoc;
        var idmain = itemCart.id + 'main';
        var idprice = itemCart.id + 'price';
        var html = '<div class="cart-item" id="' + idmain + '">\n' +
            '    <div class="row form-group">\n' +
            '        <div class="col-8"><h3>' + itemCart.name + '</h3></div>\n' +
            '        <div class="col-4">\n' +
            '            <div class="float-right" >\n' +
            '                <a onclick="xoa(' + id + ')"><i class="far fa-times-circle"></i></a>\n' +
            '            </div>\n' +
            '        </div>\n' +
            '    </div>\n' +
            '    <div class="row form-group">\n' +
            '        <div class="col-3"><img class="cart-item-img" src="/upload/' + itemCart.image + '" alt=""></div>\n' +
            '        <div class="col-9">' + itemCart.description + '</div>\n' +
            '    </div>\n' +
            '    <hr>\n' +
            '    <div class="row form-group">\n' +
            '        <div class="col-6 top">\n' +
            '           <a class="giam btn-giam" onclick="giam(' + id + ')">\n' +
            '               <img class="giam" src="../img/icon/giam.png" alt="giam">\n' +
            '           </a>\n' +
            '           <span class="sl" id="' + itemCart.id + '">' + itemCart.amount + '</span>\n' +
            '           <a class="tang btn-tang" onclick="tang(' + id + ')">\n' +
            '               <img class="tang" src="../img/icon/tang.png" alt="tang">\n' +
            '           </a>\n' +
            '        </div>\n' +
            '        <div class="col-6 down"><div class="float-right" id="' + idprice + '"><span>' + price + '<small>.000đ</small></span></div></div>\n' +
            '    </div>\n' +
            '</div>';
        return html;
    }
</script>